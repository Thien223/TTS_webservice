<!DOCTYPE html>
<head>
    <meta charset="utf-8">
    <title>표준어-사투리 변환 TTS 서비스</title>
    <!-- <meta http-equiv="refresh" content="3600"> -->
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="stylesheet" href="static/css/stylesheet.css"/>
    <link rel="stylesheet" href="static/css/jquery-ui.css"/>
    <script src="static/js/jquery-1.12.4.js"></script>
    <script src="static/js/jquery-ui.js"></script>
    <script src="static/js/setOperations.js"></script>
	<script src="static/highcharts_modules/jquery.min.js"></script>
	<script src="static/highcharts_modules/highcharts.js"></script>
	<script src="static/highcharts_modules/highcharts-more.js"></script>
	<script src="static/highcharts_modules/data.js"></script>
	<script src="static/highcharts_modules/series-label.js"></script>
	<script src="static/highcharts_modules/export-data.js"></script>
	<script src="static/highcharts_modules/exporting.js"></script>
	<script src="static/highcharts_modules/es6-promise.min.js" integrity="sha256-45YA33UQCDcJsntBst2bhka2t/LBNHP7RNvpllHPkQ0=" crossorigin="anonymous"></script>
    <script src="static/highcharts_modules/es6-promise.auto.min.js" integrity="sha256-OI3N9zCKabDov2rZFzl8lJUXCcP7EmsGcGoP6DMXQCo=" crossorigin="anonymous"></script>
	<script src="static/highcharts_modules/fetch.min.js" integrity="sha256-eOUokb/RjDw7kS+vDwbatNrLN8BIvvEhlLM5yogcDIo=" crossorigin="anonymous"></script>
	<script src="static/highcharts_modules/d3-dsv.v1.min.js"></script>
    <script src="static/highcharts_modules/d3-fetch.v1.min.js"></script>
<script>
	var Sound = (function () {
		var df = document.createDocumentFragment();
		return function Sound(src) {
			var snd = new Audio(src);
			df.appendChild(snd); // keep in fragment until finished playing
			snd.addEventListener('ended', function () {df.removeChild(snd);});
			snd.play();
			return snd;
		}
	}());

    String.prototype.includes = function (str) {
        var returnValue = false;

        if (this.indexOf(str) !== -1) {
            returnValue = true;
        }

        return returnValue;
    };

    String.prototype.trim = function () {
        return this.toString().replace(/^\s+|\s+$/g, '');
    };

    Array.prototype.indexOfDate = function(date){
        for (var i = 0; i < this.length; i++){
            if (+this[i] === +date) return i;
        };
        return -1;
    };
    /// show context menu:
    $(document).bind("contextmenu", function(event) { 
        $("div.custom-menu").hide();
        if(event.pageX>336 && event.pageX <1598 && event.pageY>80 && event.pageY<235){
            event.preventDefault();
            $("<div class='custom-menu'>테스트 정리</div>")
            .appendTo("body")
            .css({top: event.pageY + "px", left: event.pageX + "px"});
        }
        $("div.custom-menu").click(function() {
            $("div.custom-menu").hide();
            ////////////////////////////////////////////// check data existance
			var selected_date = document.getElementById("input-text").value="Type text to synthesize";

            
        });
    });
    $(document).bind("click", function(event) { $("div.custom-menu").hide();});
    
    function exportTableToCSV($table,temperature_col, filename) {
        var $rows = $table.find('tr:has(td)');
        ///keep 3 first rows only (송전단 과 시간 행)
        $rows = $rows.slice(0,3);
            // Temporary delimiter characters unlikely to be typed by keyboard
            // This is to avoid accidentally splitting the actual contents
            tmpColDelim = String.fromCharCode(11), // vertical tab character
            tmpRowDelim = String.fromCharCode(0), // null character
            // actual delimiter characters for CSV format
            colDelim = '","',
            rowDelim = '"\r\n"',
            csv = '';
            // Grab text from table into CSV formatted string
            csv = csv + $rows.map(function (i, row) {
                var $row = $(row), $cols = $row.find('td');
                if(i==0){
                    $cols = $cols.slice(2);
                    return $cols.map(function (j, col) {
                        var $col = $(col);
                        if(!$col.text().includes("+") && !$col.text().includes("-"))
                            var text = '[*'+$col.text()+']';//+colDelim+ temperature_col[i];
                        else{
                            var text = '['+$col.text()+']';//+colDelim+ temperature_col[i];
                        }
                        // return text.replace(/"/g, '""'); // escape double quotes
                        return text; // escape double quotes
                    }).get().join(tmpColDelim);
                }else{
                    return $cols.map(function (j, col) {
                        var $col = $(col), text = $col.text();
                        // return text.replace(/"/g, '""'); // escape double quotes
                        return text; // escape double quotes
                    }).get().join(tmpColDelim);
                }
            }).get().join(tmpRowDelim)
                .split(tmpRowDelim).join(rowDelim)
                .split(tmpColDelim).join(colDelim) + '"';

            /// because the table is in horizontal, we need converting to vertical direction
            ///convert temperature array to string
            temperature_col = temperature_col.map(function(number){
                return parseFloat((Math.round(number*10)/10).toFixed(1));
            });
            var string_temp = JSON.stringify(temperature_col);
            /// add quotes
            string_temp = string_temp.replace(/,/g,'","').replace("[",'"').replace("]",'"');
            /// split csv data
            var csv_list = csv.split("\r\n");
            //add temperature column into 2nd index
            csv_list.splice(1,0,string_temp);
            
            //swap row and column of csv data, add column title
            csv_='"거래시간","온도","GT가용량","CC가용량"\r\n"';
            ///keep only 송전량 데이터 (title and 2 first rows)
            for(i=0;i<34;i++){
                csv_ += csv_list[0].split(',')[i] +','+ csv_list[1].split(',')[i] + ','+csv_list[2].split(',')[i] + ','+csv_list[3].split(',')[i]+'\r\n';
            }
            // Data URI
            // remember to add \uFEFF char befor csv series
            csvData ='data:application/csv;charset=utf-8,' + encodeURIComponent('\uFEFF' + csv_);
            if (window.navigator.msSaveBlob) { // IE 10+
                //alert('IE' + csv);
                window.navigator.msSaveOrOpenBlob(new Blob(['\uFEFF' + csv_], {type: "text/csv;charset=utf-8;"}), filename)
            } 
            else {
                $(this).attr({ 'download': filename, 'href': csvData, 'target': '_blank' }); 
            }
        }



    function exportOriginalData(data, temperature_col, filename) {
        var t_ = '[-1801]","[-1901]","[-2001]","[-2101]","[-2201]","[-2301]","[*0001]","[*0101]","[*0201]","[*0301]","[*0401]","[*0501]","[*0601]","[*0701]","[*0801]","[*0901]","[*1001]","[*1101]","[*1201]","[*1301]","[*1401]","[*1501]","[*1601]","[*1701]","[*1801]","[*1901]","[*2001]","[*2101]","[*2201]","[*2301]","[+0001]","[+0101]","[+0201]","[+0301]"'
        temperature_col = temperature_col.map(function(number){
            return parseFloat((Math.round(number*10)/10).toFixed(1));
        });
        var string_temp = JSON.stringify(temperature_col);
        /// add quotes
        string_temp = string_temp.replace(/,/g,'","').replace("[",'"').replace("]",'"');


        //swap row and column of csv data, add column title
        csv_='"거래시간","온도","송전 GT가용량","송전 CC가용량","발전 GT가용량","발전 CC가용량"\r\n"';
        ///keep only 송전량 데이터 (title and 2 first rows)
        for(i=0;i<34;i++){
            csv_ += t_.split(',')[i]+','+ string_temp.split(',')[i] + ',"'+data.gt_transfer_predicted[i] + '","'+data.cc_transfer_predicted[i]+'","'+data.gt_generate_predicted[i]+'","'+data.cc_generate_predicted[i]+'"\r\n';
        }
        csvData ='data:application/csv;charset=utf-8,' + encodeURIComponent('\uFEFF' + csv_);
        if (window.navigator.msSaveBlob) { // IE 10+
            //alert('IE' + csv);
            window.navigator.msSaveOrOpenBlob(new Blob(['\uFEFF' + csv_], {type: "text/csv;charset=utf-8;"}), filename);
        } 
        else {
            downloadURI(csvData,filename);
        }

        
    }


        
    var temperature_col;
    var data;
    var current_tab = "gt";
    var pressure = [];
    var gt_generate_name_list = [];
    var cc_generate_name_list = [];
    var gt_send_name_list = [];
    var cc_send_name_list = [];
    var _suffix=['01','02','03','04','05','06','07','08','09','10','11','12','13','14','15','16','17','18','19','20','21','22','23','24','25','26','27','28','29','30','31','32','33','34'];
    _suffix.forEach(function(element){
        gt_generate_name_list.push("#generated-power-gt--" + element);
        cc_generate_name_list.push("#generated-power-cc--" + element);
        gt_send_name_list.push("#send-power-gt--" + element);
        cc_send_name_list.push("#send-power-cc--" + element);       
    });
    ///read csv file, add random number to prevent caching the file
    d3.csv("static/data/inlet_clean_info.csv" + "?" + Math.floor(Math.random() * 10000)).then(function(data) {
        var today = new Date();
        var clean_time = data[0].cleaned_time;
        //display info on site
        $("#nearest_cleaned_time").html(clean_time);
        var clean_time = data[0].cleaned_time.replace(/-/g,"/");
        clean_time = new Date(clean_time);
        var hours = Math.abs(today - clean_time) / 36e5;
        hours = Math.round(hours);
        $("#EOH").html(hours);
        var tested_power = data[0].tested_power_output;
        tested_power = Math.floor(tested_power*1000)/1000;
        $("#test_power").html(tested_power);
    });
    //// remove duplicate elements from an array, return it's sub array
    function removeDups(array) {
        let unique = {};
        array.forEach(function(i) {
            if(!unique[i]) {unique[i] = true;}
        });
        return Object.keys(unique)
    };

    ///simple function to clear html table content
    function reset_table(){
        $('#form').find('input, textarea').not("#txt-cleaned-time").val('');
        for(i=0;i<34;i++){
            $(gt_generate_name_list[i]).html(" ");
            $(cc_generate_name_list[i]).html(" ");
            $(gt_send_name_list[i]).html(" ");
            $(cc_send_name_list[i]).html(" ");
        };
    };
    //// make to tab button (GT,CC) to be activated
    function activeTabButton(evt, buttonName) {
        // Get all elements with class="tablinks" and remove the class "active"
        tablinks = document.getElementsByClassName("tab-button");
        for (i = 0; i < tablinks.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" tab-button-active", "");
        }
        evt.currentTarget.className += " tab-button-active";
    };
    ////// function to download file
    function downloadURI(uri, name) 
    {
        var link = document.createElement("a");
        link.download = name;
        link.href = uri;
        link.click();
    }
    $(function(){
        $("#dnl-template").click(function(){
            downloadURI('static/data_templates/templates.zip', 'templates.zip');
        });
    });
    
    
    $(function(){
        $("#csv").click(function(){
            document.getElementById("file").click();
        });
    });
    ///// trigger '산출' button to calculate
    $(function(){
        $('#ml-form_submit').click(function(){
            $.ajax({
                url: '/ml-inference',
                data: $('form').serialize(),
                type: 'POST',
                success: function(response){
					////번역
					
					translated_text = response.translated_text
					audio_stream = response.audio_stream
                    /////////// successfully calculated/////////////////
                    document.getElementById("translated-results").innerHTML= "번역된 문장: '" + translated_text +"'";
					console.log("translated_text:" + translated_text);
					document.getElementById("audio-player").src = "data:audio/wav;base64,"+ audio_stream;
					
                },
                error: function(error){
                    alert("합성은 실패하였습니다. 오류: " + (error.statusText));
                }
            });

        });
    });
    //// handling of date dropdown listbox changed 
    $(function(){   
        $("#date-select").change(function(){
            data = null;
            ///clear message
            $("#warning-message").html("");
            temperature_col = null;
            ////get tempearture input textbox html element (to assign values or remove values latter)
            var txts = document.getElementsByClassName("temperature-input-textbox");
            document.getElementById("txt-pressure").value="";
            for(i=0;i<txts.length;i++){
                txts[i].value="";
            }
            var select_element = document.getElementById("date-select");
            var opt = select_element.value;
            var temps=[];
            var opt_date = new Date(opt.replace(/-/g,"/"));
            var flag=false;
            ///read temperature file to fill up the input textbox of temperature
            d3.csv("static/data/temperature.csv" + "?" + Math.floor(Math.random() * 10000)).then(function(data) {
                var temps=[];
                var press_;
                var opt_date = new Date(opt.replace(/-/g,"/"));
                var weekday = (new Date()).getDay();
                for (i=0;i<data.length;i++){
                    time_in_data = new Date(data[i].time.replace(/-/g,"/"));
                    if ((time_in_data - opt_date) / 36e5 / 24 ==0){
                        press_=data[i].pressure;
                        temps.push(data[i].yes_15);
                        temps.push(data[i].yes_18);
                        temps.push(data[i].yes_21);
                        temps.push(data[i].tod_0);
                        temps.push(data[i].tod_3);
                        temps.push(data[i].tod_6);
                        temps.push(data[i].tod_9);
                        temps.push(data[i].tod_12);
                        temps.push(data[i].tod_15);
                        temps.push(data[i].tod_18);
                        temps.push(data[i].tod_21);
                        temps.push(data[i].tom_0);
                        temps.push(data[i].tom_3);
                        temps.push(data[i].tom_6);
                        flag=true;
                        break;
                    }
                }
                ////if there is not data of selected date, and today is Friday, using medium_term_temperature.csv file
                if(flag==false){
                    d3.csv("static/data/medium-term-temperature.csv" + "?" + Math.floor(Math.random() * 10000)).then(function(lt_data){
                        temps=[];
                        for(i=0;i<lt_data.length;i++){
                            var time_in_data = new Date(lt_data[i].time.replace(/-/g,"/"));
                            if((time_in_data - opt_date) / 36e5 / 24 == 0){
                                temps.push(lt_data[i].yes_min);
                                temps.push(lt_data[i].yes_min);
                                temps.push(lt_data[i].yes_min);
                                temps.push(lt_data[i].tod_min);
                                temps.push(lt_data[i].tod_min);
                                temps.push(lt_data[i].tod_min);
                                temps.push(lt_data[i].tod_average);
                                temps.push(lt_data[i].tod_max);
                                temps.push(lt_data[i].tod_max);
                                temps.push(lt_data[i].tod_max);
                                temps.push(lt_data[i].tod_average);
                                temps.push(lt_data[i].tom_min);
                                temps.push(lt_data[i].tom_min);
                                temps.push(lt_data[i].tom_min);
                                break;
                            }
                        }
                        for(i=0;i<temps.length;i++){
                            txts[i].value=temps[i];
                        }
                        if(press_!=null){
                            document.getElementById("txt-pressure").value=press_;
                        }else{
                            document.getElementById("txt-pressure").value="";
                        } 
                    }); 
                }
                
                
                //// if there is data, just fill up
                if(flag==true){
                    for(i=0;i<temps.length;i++){
                        txts[i].value=temps[i];
                    }
                    if(press_!=null){
                        document.getElementById("txt-pressure").value=press_;
                    }else{
                        document.getElementById("txt-pressure").value="";
                    } 
                } 
            });
        });
    });
    //// calculate power generation using valina function
    $(function(){
        $('#form_submit').click(function(){
            $("#warning-message").html("");
            
            if(form_validation()==true){
                $.ajax({
                    url: '/inference',
                    data: $('form').serialize(),
                    type: 'POST',
                    success: function(response){
                        /////////// successfully calculated/////////////////
                        data = JSON.parse(response);
                        temperature_col =  data.temperature;
                        
                        for(i=0;i<34;i++){
                            $(gt_generate_name_list[i]).html(Math.round(data.gt_generate_predicted[i]));
                            $(cc_generate_name_list[i]).html(Math.round(data.cc_generate_predicted[i]));
                            $(gt_send_name_list[i]).html(Math.round(data.gt_transfer_predicted[i]));
                            $(cc_send_name_list[i]).html(Math.round(data.cc_transfer_predicted[i]));
                            /// returned pressure is a number, convert to array for plotting graph
                            pressure.push(data.pressure);
                        };
                        if (current_tab=="gt"){
                            ////// draw power reduction graph
                            ////// draw power reduction graph
                            var power_reduction = data.power_reduction.slice(6,30).map(function(element){
                                return element / 1000;
                            });
                            draw_power_reduction(power_reduction);
                            ////// draw generated power + temperature + barometric pressure graph
                            var power_min = Math.min.apply(null,data.gt_generate_predicted) - (Math.max.apply(null,data.gt_generate_predicted)/2 - Math.min.apply(null,data.gt_generate_predicted)/2);
                            draw_output(data.gt_generate_predicted.slice(6,30), data.temperature.slice(6,30), pressure.slice(6,30), power_min, document.getElementById('date-select').value);
                        }else{
                            ////// draw power reduction graph
                            ////// draw power reduction graph
                            var power_reduction = data.power_reduction.slice(6,30).map(function(element){
                                return element / 1000;
                            });
                            draw_power_reduction(power_reduction);
                            ////// draw generated power + temperature + barometric pressure graph
                            var power_min = Math.min.apply(null,data.cc_generate_predicted) - (Math.max.apply(null,data.cc_generate_predicted)/2 - Math.min.apply(null,data.cc_generate_predicted)/2);
                            draw_output(data.cc_generate_predicted.slice(6,30), data.temperature.slice(6,30), pressure.slice(6,30), power_min, document.getElementById('date-select').value);
                        }
                        
                    },
                    error: function(error){
                        if (error.status == 500){
                            alert("산출 실패하였습니다. 오류: 500 파일 존재하지 않습니다. 업데이트 필요합니다. ");
                        }else{
                            alert("산출 실패하였습니다. 오류: " + (error.statusText));
                        }
                        
                    }
                });
            }
        });
    }); 
    ///function to calculate difference between 2 date (in month)
    function monthDiff(dateFrom, dateTo) {
        return dateTo.getMonth() - dateFrom.getMonth() + (12 * (dateTo.getFullYear() - dateFrom.getFullYear()))
    };


    ///function to calculate mean of array
    function mean(array){
        var sum=0;
        for(i=0;i<array.length;i++){
            sum+=array[i];
        }
        return sum/array.length
    }
    /// and sum of it
    function sum(array){
        var sum=0;
        for(i=0;i<array.length;i++){
            sum+=array[i];
        }
        return sum
    }

    ///// schedule calculation, if today is Friday, and there is no data in temperature.csv
    var $j = jQuery.noConflict();
    $j( function() {
        $("#date-select").datepicker({ dateFormat: 'yy-mm-dd' });
    });

    //// each time uploading csv files
    $(function(){
        $("#file").change(function(){
            if(check_ext()){
                var form_data = new FormData($("#form")[0]);
                $.ajax({
                    url: '/uploadss',
                    // data: $('form').serialize(),
                    data: form_data,
                    type: 'POST',
                    contentType: false,
                    cache: false,
                    processData: false,
                    async: false,
                    success: function(response){
                        if(response == "file uploaded successfully"){
                            alert("정상 처리 되었습니다.");
                        }else if (response =="filename is not acceptable"){
                            alert("파일 이름 일치하지 않기로 파일 업데이드 실패하였습니다.");
                        }
                        var txts = document.getElementsByClassName("temperature-input-textbox");
                        document.getElementById("txt-pressure").value="";
                        for(i=0;i<txts.length;i++){
                            txts[i].value="";
                        }
                        var select_element = document.getElementById("date-select");
                        var opt = select_element.value;
                        d3.csv("static/data/inlet_clean_info.csv" + "?" + Math.floor(Math.random() * 10000)).then(function(data) {
                            var today = new Date();
                            var clean_time = data[0].cleaned_time;
                            $("#nearest_cleaned_time").html(clean_time);

                            var clean_time = data[0].cleaned_time.replace(/-/g,"/");
                            clean_time = new Date(clean_time);
                            var hours = Math.abs(today - clean_time) / 36e5;
                            hours = Math.round(hours);
                            
                            $("#EOH").html(hours);


                            var tested_power = data[0].tested_power_output;
                            tested_power = Math.floor(tested_power*1000)/1000;
                            $("#test_power").html(tested_power);
                        });

                        d3.csv("static/data/temperature.csv" + "?" + Math.floor(Math.random() * 10000)).then(function(data) {
                            var temps=[];
                            var press_;
                            var opt_date = new Date(opt.replace(/-/g,"/"));
                            for (i=0;i<data.length;i++){
                                time_in_data = new Date(data[i].time.replace(/-/g,"/"));

                                if ((time_in_data - opt_date) / 36e5 / 24 ==0){
                                    press_=data[i].pressure;
                                    temps.push(data[i].yes_15);
                                    temps.push(data[i].yes_15);
                                    temps.push(data[i].yes_15);
                                    temps.push(data[i].tod_0);
                                    temps.push(data[i].tod_3);
                                    temps.push(data[i].tod_6);
                                    temps.push(data[i].tod_9);
                                    temps.push(data[i].tod_12);
                                    temps.push(data[i].tod_15);
                                    temps.push(data[i].tod_18);
                                    temps.push(data[i].tod_21);
                                    temps.push(data[i].tom_0);
                                    temps.push(data[i].tom_3);
                                    temps.push(data[i].tom_6);
                                }
                            }
                            for(i=0;i<temps.length;i++){
                                txts[i].value=temps[i];
                            }
                            if(press_!=null){
                                document.getElementById("txt-pressure").value=press_;
                            }else{
                                document.getElementById("txt-pressure").value="";
                            }
                        });

                    },
                    error: function(error){
                        if (error.status == 500){
                            alert("산출 실패하였습니다. 오류: 500 파일 존재하지 않습니다. 업데이트 필요합니다. ");
                        }else{
                            alert("산출 실패하였습니다. 오류: " + (error.statusText));
                        }
                        
                    }
                });
            }
        });
    });
    
    
    ///form validatioon function
    function form_validation(){
        var textbox_list = document.getElementsByClassName('temperature-input-textbox');
        var array=[];
        var error = true;
        for (i=0;i<textbox_list.length;i++){
            array.push(textbox_list[i]);
        }
        array.forEach(function(element) {
            if (element.value==''){
                $("#warning-message").html("* 온도를 입력해 주세요!");
                error = false;
                return error;
            }else if(-50>element.value || element.value>70){
                $("#warning-message").html("* 온도는 -50~70도 입니다!");
                error = false;
                return error;
            }
        });
        
        var textbox_pressure = document.getElementById("txt-pressure");
        if (800>textbox_pressure.value || textbox_pressure.value>1200){
            $("#warning-message").html("* 대기압은 800~1200 mbar 입니다!");
            error = false;
            return error;
        }else if (textbox_pressure.value==""){
            $("#warning-message").html("* 대기압을 입력해 주세요!");
            error = false;
            return error;
        }
        var textbox_cleaned_time = document.getElementById("txt-cleaned-time");
        if (textbox_cleaned_time.value<0){
            $("#warning-message").html("* 수세정후 시간은 음수 아닙니다!");
            error = false;
            return error;
        }else if (textbox_cleaned_time.value==""){
            $("#warning-message").html("* 수세정후 시간을 입력해 주세요!");
            error = false;
            return error;
        }
        if (isNaN(Date.parse(document.getElementById('date-select').value))){
            
            $("#warning-message").html("* 거래일자는 날짜 포맷입니다!");
            error = false;
            return error;
        }else{
            if(document.getElementById('date-select').value.split('-').length<3){
                $("#warning-message").html("* 거래일자는 날짜 포맷입니다!");
                error = false;
                return error;
            }
        }
        return error;
        
    };



    //checking for valid number 
    $(document).on('change', '.temperature-input-textbox', function() { 
        var input_value = parseFloat($(this).val());
        if(isNaN(input_value)) { input_value = 0; }
        $(this).val(input_value);
    });
    $(document).on('change', '.textbox-input', function() { 
        var input_value = parseFloat($(this).val());
        if(isNaN(input_value)) { input_value = 0; }
        $(this).val(input_value);
    });
    
    //clear textbox everytime click on it
    $(document).on('focus', '.temperature-input-textbox', function() {
        $(this).val('');
    });
    $(document).on('focus', '#txt-pressure', function() { 
        $(this).val('');
    });

    ////function display the realtime clock
    function display_time(){
        var interval=1000 /// 1second interval;
        time = setTimeout('display_clock()',interval)
    };


    function display_clock(){
        var date = new Date();
        time = pad2(date.getHours( ))+ ":" +  pad2(date.getMinutes()) + ":" +  pad2(date.getSeconds());
        $('#clock').html(time)
        display_time();
    };

    
    //// function to add 0 ahead of single number
    function pad2(number) {
        return (number < 10 ? '0' : '') + number
    };

    //// create a list of dates from startDate to endDate
    var today = new Date();
    //var startDate = new Date(today.getFullYear(), 0, 1);
    var startDate = today;
    var endDate = new Date(today.getFullYear(),today.getMonth(),today.getDate()+72); //YYYY-MM-DD
    //// function to generate dates list
    var getDateArray = function(start, end) {
        var arr = new Array();
        var dt = new Date(start);
        while (dt <= end) {
            arr.push(new Date(dt).toISOString().split("T")[0]);
            dt.setDate(dt.getDate() + 1);
        }
        /// add the last day of year
        arr.push(new Date(dt).toISOString().split("T")[0]);
        return arr
    }
    //// listup the dates
    datesList = getDateArray(startDate, endDate);
    ///// generate tables
    $(document).ready(function(){
        $("#export-to-csv-button").click(function(){
            if (temperature_col==null){
                alert("먼저 산출하세요!");
                return;
            }else{
                document.getElementById("export-to-csv").click();
            }
            
        });
        $("#export-to-csv").on('click', function (event) {
            var selected_date = document.getElementById("date-select").value.replace(/-/g,"")
            var filename = "bid_2637_" + selected_date + ".csv";
            exportTableToCSV.apply(this, [$('#data-table'),temperature_col, filename]);
        });
        ///// convert weekday from int to hangul text
        var date = new Date();
        year = date.getFullYear();
        month= date.getMonth()+1;
        day=date.getDate();
        weekday = date.getDay();
        if (weekday==1){
            wd ='월요일';
        }else if (weekday==2){
            wd ='화요일';
        }else if (weekday==3){
            wd ='수요일';
        }else if (weekday==4){
            wd ='목요일';
        }else if (weekday==5){
            wd ='금요일';
        }else if (weekday==6){
            wd ='토요일';
        }else{
            wd ='일요일';
        }
        //display on site
        $('#div-info-date').html(year +'년 '+month+'월 '+day+'일, ' + wd);
        // today = pad2(year)+"-"+pad2(month)+"-"+pad2(day)
        // // $('#date-select').empty();
        // $.each(datesList, function(i, p) {
        //     if (today === p){
        //         $('#date-select').append($('<option selected="selected"></option>').val(p).html(p));
        //     }else{
        //         $('#date-select').append($('<option></option>').val(p).html(p));
        //     }
        // });

        //// draw calculated table
        table_body = "<tr>";
        table_body+="<td>구분</td>";
        table_body+="<td>거래 시간</td>";
        hour = 17;
        for(i=0;i<34;i++){
            hour +=1;
            if(Math.floor(hour/24)<1){
                table_body+="<td>-"+pad2(hour%24)+"01</td>";
            }else if(Math.floor(hour/24)==1){
                table_body+="<td>"+pad2(hour%24)+"01</td>";
            }else{
                table_body+="<td>+"+pad2(hour%24)+"01</td>";
            }
        };
        
        $('#generated-output-data-head').html(table_body);
        table_body = "" ;
        var table_body_gt="<tr><th rowspan='2'>송전단</th><th>GT</th>";
        var table_body_cc="<tr><th>CC</th>";
        hour=0;
        for(i=0;i<34;i++){
        hour +=1;
            table_body_gt+="<td name='send-power-gt--"+pad2(hour)+"' id='send-power-gt--"+pad2(hour)+"'></td>";
            table_body_cc+="<td name='send-power-cc--"+pad2(hour)+"' id='send-power-cc--"+pad2(hour)+"'></td>";
        };
        table_body_gt+="</tr>";
        table_body_cc+="</tr>";
        table_body += table_body_gt+table_body_cc;
        var table_body_gt_="<tr><th rowspan='2'>발전단</th><th>GT</th>";
        var table_body_cc_="<tr><th>CC</th>";
        hour=0;
        for(i=0;i<34;i++){
            hour +=1;
            table_body_gt_+="<td name='generated-power-gt--"+pad2(hour)+"' id='generated-power-gt--"+pad2(hour)+"'></td>";
            table_body_cc_+="<td name='generated-power-cc--"+pad2(hour)+"' id='generated-power-cc--"+pad2(hour)+"'></td>";     
        };
        table_body_gt_+="</tr>";
        table_body_cc_+="</tr>";
        table_body += table_body_gt_+table_body_cc_;
        $('#generated-output-data').html(table_body);
            ////// draw temperature table
        table_body = "" 
        hour = 12
        for(i=0;i<14;i++){
                hour +=3
                if(Math.floor(hour/24)<1){
                    table_body+="<tr><td width='20%'>-"+pad2(hour%24)+"</td><td><input name='input-temp--"+pad2(hour%24)+"' class='temperature-input-textbox' type='text' placeholder='입력온도'/></td></tr>"            
                }else if(Math.floor(hour/24)==1){
                    table_body+="<tr><td width='20%'>"+pad2(hour%24)+"</td><td><input name='input-temp-"+pad2(hour%24)+"' class='temperature-input-textbox' type='text' placeholder='입력온도'/></td></tr>"            
                }else{
                    table_body+="<tr><td width='20%'>+"+pad2(hour%24)+"</td><td><input name='input-temp--"+pad2(hour%24)+"' class='temperature-input-textbox' type='text' placeholder='입력온도'/></td></tr>"            
                }
            };
        $('#input-temperature').html(table_body);
    });

    function check_ext(){
        var regexp;
        var file_element = document.getElementById("file")
        var extension =     file_element.value.substr(file_element.value.lastIndexOf('.'));
        if ((extension.toLowerCase() != ".csv") && (extension != "")){
            alert("csv 포맷만 업로드 가능합니다.");
            theForm.file.focus();
            return false;
        }
        return true;
    }
    ///// function to clear default text of input textbox
    function empty_default(obj){
        var textbox = obj;
        var txt = textbox.value
        if(txt.trim()!=""){
            textbox.value=""
        }
    }
    ///// function to clear default text of input text area
    function empty_default_input_text(){
        var textbox = document.getElementById("input-text");
        var txt = textbox.value
        if(txt.trim()=="Type text to synthesize"){
            textbox.value=""
        }
    }
    ///// function to set default text for input text area
    function set_default_input_text(){
        var textbox = document.getElementById("input-text");
        var txt = textbox.value
        if(txt.trim()==""){
            textbox.value="Type text to synthesize"
        }
    }
</script>
</head>
<body onload=display_time();>
    <div id="wrapper">
        <!-- left container-->
        <div id="left-container">
            <div id="div-logo">
                <img src="static/icons/locs_logo.png" width="100%" height ="auto"/>
            </div>
            <hr/><hr/><hr/>
            <div id="div-system-infos">
                    <div id="div-info-station">
                            <span style="display:block;font-weight:bolder; font-size:large; color:rgb(188, 238, 89)">표준어-사투리 <br> 변환 TTS 서비스</span>
                    </div>
                    <hr/>
                    <div id="div-info-date">
                        Systenm's info
                    </div>
                    <hr/>
                    <div id="div-info-clock">
                        <span>현재시간:</span>
                        <span id="clock"></span>
                    </div>
                    <hr/>
            </div>
            <hr/>
        </div>

        
        <!-- right container-->
        <div id="graph-container">
            <div id="graph-upper-container">
                <form role="form" id="form" name="input_form" method="POST" enctype="multipart/form-data">
                        <div class="div-output" id="div-power-output-wrapper">
                            <div class="upper-input" id="div-pressure-cleaned-input">
                                
                                <div style="float:left; height:100%">
                                    <button class="button" type="reset" name="reset">다시 입력</button>
                                    <button class="button" type="button" name="ml-submit" id="ml-form_submit">변환</button>
                                    <a href="#" id="export-to-csv" style="display:none"></a>
                                </div>
                                
                            </div>
                            <div id="div-power-output" class="lower-element">
                                <textarea name="input-text" method="POST" form="form" id="input-text" cols="auto" rows="auto" onfocus="empty_default_input_text();" onblur="set_default_input_text();">Type text to synthesize</textarea>
                            </div>

                            <div class="button-inlet-type">
                                    <span id='warning-message'></span>
                            </div>
                        </div>
                        <div class="div-input" id="div-date-input">
                            <table id="div-select-options-wrapper">
                                <tbody>
                                    <tr>
                                        <td>
                                            <span class="txt-label">캐릭터:</span>
                                        </td>
                                        <td>
                                            <input class="model-options-select" type = "text" list = "gender-data" name="gender-options" onfocus="empty_default(this);" onclick="empty_default(this);">
                                            <datalist id="gender-data">
                                                <option value="남성" selected="selected"></option>
                                                <option value="여성"></option>
                                            </datalist>
                                        </td>
                                        <td>
                                            <span class="txt-label">음성 종류:</span>
                                        </td>
                                        <td>
                                            <input class="model-options-select" type = "text" list = "model-type-data" name="model-type-options" onfocus="empty_default(this);" onclick="empty_default(this);">
                                            <datalist id="model-type-data">
                                                <option value="표준"></option>
                                                <option value="제주" selected="selected"></option>
                                                <option value="전라"></option>
                                                <option value="경상"></option>
                                                <option value="부산"></option>
                                            </datalist>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                </form>
            </div>
            <div id="graph-lower-container">
                <!-- container of 발전-송전 그림과 출력저하 그림 -->
                <!-- Player -->
                <div id="translated-results"><span>번역된 테스트: </span></div>

                <!-- audio player-->
                <div id="audio-result">
                    <audio controls id="audio-player" autobuffer="autobuffer" autoplay="autoplay"></audio>
                </div>
            </div>
        </div>
    </div>


</body>