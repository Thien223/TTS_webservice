<!DOCTYPE html>
<head>
    <meta charset="utf-8">
    <!-- <meta http-equiv="refresh" content="3600"> -->
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="stylesheet" href="static/css/stylesheet.css"/>
    <script src="static/js/setOperations.js"></script>
	<script src="static/highcharts_modules/jquery.min.js"></script>
	<script src="static/highcharts_modules/highcharts.js"></script>
	<script src="static/highcharts_modules/highcharts-more.js"></script>
	<script src="static/highcharts_modules/data.js"></script>
	<script src="static/highcharts_modules/series-label.js"></script>
	<script src="static/highcharts_modules/export-data.js"></script>
	<script src="static/highcharts_modules/exporting.js"></script>
	<script src="static/highcharts_modules/es6-promise.min.js" integrity="sha256-45YA33UQCDcJsntBst2bhka2t/LBNHP7RNvpllHPkQ0=" crossorigin="anonymous"></script>
    <script src="static/highcharts_modules/es6-promise.auto.min.js" integrity="sha256-OI3N9zCKabDov2rZFzl8lJUXCcP7EmsGcGoP6DMXQCo=" crossorigin="anonymous"></script>
	<script src="static/highcharts_modules/fetch.min.js" integrity="sha256-eOUokb/RjDw7kS+vDwbatNrLN8BIvvEhlLM5yogcDIo=" crossorigin="anonymous"></script>
	<script src="static/highcharts_modules/d3-dsv.v1.min.js"></script>
    <script src="static/highcharts_modules/d3-fetch.v1.min.js"></script>

    <!-- <style>

        /* CSS reset */
        html, body, div, span, applet, object, iframe,
        h1, h2, h3, h4, h5, h6, p, blockquote, pre,
        a, abbr, acronym, address, big, cite, code,
        del, dfn, em, font, img, ins, kbd, q, s, samp,
        small, strike, strong, sub, sup, tt, var,
        dl, dt, dd, ol, ul, li,
        fieldset, form, label, legend,
        table, caption, tbody, tfoot, thead, tr, th, td {margin: 0;padding: 0;border: 0;outline: 0;font-weight: inherit;font-style: inherit;font-size: 100%;font-family: inherit;vertical-align: baseline;}
        ol, ul {list-style: none;}
        /* tables still need 'cellspacing="0"' in the markup */
        /* caption, th, td {text-align: left;} */

        /*global setting*/
        *{margin:0;padding:0;color:#5c6873}
        body {vertical-align: middle;background-color: rgb(1, 14, 22);line-height: 1.608;margin:0;padding:0;font-family: sans-serif;width: 100vw;  position: relative;  left: 50%;  right: 50%;  margin-left: -50vw;  margin-right: -50vw; }
        table{color: #F8FAFC !important;width: 100%;}
        table > thead,table > thead > tr > td > span{background-color: #5C6873 !important;color : 	#F8FAFC !important;font-weight: bolder !important;text-align: center;}
        tr > td{padding: 5px;}
        table > tbody > tr > td {background-color: #F8FAFC;color: #5C6873;}
        /* div{display:block; float:left} */
        input,select{    background-color: #F8FAFC;border: solid 1px #5C6873;width: 100%;height: 100%;border-radius: 3px;}
        hr {border: solid 1px #3A4146;}
        span {background-color: transparent;}
        /*classified elements class setting*/
        .button:hover{background-color: #008CBA;}
        .button {background-color: #20a8d8;color: #F8FAFC;font-weight: bold;text-align: center;text-decoration: none;display: inline-block;border: none !important;border-radius: 5px;padding: 5px;margin:0px 5px;-webkit-transition-duration: 0.4s;transition-duration: 0.4s;cursor: pointer;min-width: 70px;height:100%}
        .upper-input > div > span {color: #2F353A !important;font-weight: bold;}
        .upper-input {height:32px;}
        .text-temp{font-family: sans-serif;font-size: 40px;font-weight: bolder;}
        .temperature-input-textbox{padding:5px  ; width:95%}
        .textbox-input{padding:0 5px;width:75px;border-radius: 15px;;border: 1px solid gray;}
        .div-input, .div-output{margin: 10px;float:left}
        .table-input{max-height: 150px; overflow: auto}
        .table-input > thead > tr > td {max-height: 36px; overflow: auto}
        .data-table thead{text-align: center}
        .data-table{height: 150px; overflow: auto; width:100%}
        .lower-element{width:100%;margin:5px;max-height:250px; overflow:auto}
        .graph{margin:10px 10px; display:block;}
        .button-inlet-type{margin-left: 0%; height:44px; padding-bottom:0px}
        .tab-button{margin:7px 0px 0px 20px; border: 1px solid gray;width: 75px; height: 30px}
        .text-temp-small{padding-top:40px;font-family: sans-serif;font-size: 20px; font-weight: 400; color:rgba(190, 183, 173, 0.651)}
        .celc{color: rgba(190, 183, 173, 0.651); font-size:15px; font-weight:200; vertical-align: super}
        button.tab-button-active{margin:7px 0px 0px 20px; background-color:darkslategrey; color:rgb(255, 255, 255) ;border: 1px solid rgb(255, 255, 255);width: 75px; height: 30px}
        .div-time{font-weight: light;}
        /*private element id setting*/
        #div-system-infos,
        #div-system-infos >  div,
        #div-system-infos >  div > span,
        #div-menu-items,
        #div-menu-items >  div > div,
        #div-menu-items >  div > div > div,
        #div-menu-items >  div > div > div > span{color : #f0f3f5 !important;}
        #div-menu-items > div > div:first-child {font-size: large;background-color: #20a8d8;width: 250px;border-radius: 5px;padding: 5px;}
        #left-container #div-system-infos >  div:first-child > span{font-size: x-large;text-align: center;padding : 0.3em;color : #f0f3f5 !important;}
        #temperature{width:100%;min-height:140px;display:inline-block;text-align: center;}
        #pressure{width:100%;min-height:140px;display:inline-block;text-align: center;}

        #temp_before,#temp_now,#temp_latter{float:left;vertical-align: middle;    text-align: center;    padding: 3%;}
        #div-system-info{padding:5px;}
        #left-container{min-height: 910px; display:block;background-color: #2F353A; color: #f0f3f5;float:left;width:15%;padding: 0px; margin:0px 6px 5px 10px;font-weight:bold;text-align: left; padding:2em;border: 1px solid white;}
        #graph-container{width: 70%;padding:2em;height:inherit;float:left;color: #5C6873 !important;}
        #wrapper{vertical-align: middle; text-align: center; margin: 0px 20px;min-width: 1672px; height:100%;background-color: #f0f3f5;; color: rgb(71, 68, 68);float:left;font-family: sans-serif;width: 100vw;  position: relative;left: 50%;right: 50%;margin-left: -50vw;margin-right: -50vw; }
        #div-date-input{width: 20%}
        #div-power-output-wrapper{display:block;width:75%;}
        #div-pressure-cleaned-input{width: 100%; height:34px}
        #div-pressure-input,#div-cleaned-time-input{height:100%}
        #graph-lower-container,#graph-upper-container{display: inline-block;border-radius:20px;background-color:#E4E7EA;width: 100%;height: 100%;border: 1px solid white;;margin: 10px;}
        
        #left-graph-container{float:left; width:30%}
        #right-graph-container{float:left; width:70%}
        #div-calculated-output-graph{margin:10px 10px;height:510px; text-shadow: transparent}
        #warning-message{color:red;margin: 5px; font-size: 14px;}
    </style> -->
<script>
    String.prototype.includes = function (str) {
        var returnValue = false;

        if (this.indexOf(str) !== -1) {
            returnValue = true;
        }

        return returnValue;
    };
    Array.prototype.indexOfDate = function(date){
        for (var i = 0; i < this.length; i++){
            if (+this[i] === +date) return i;
        };
        return -1;
    };




    function exportTableToCSV($table,temperature_col, filename) {
        var $rows = $table.find('tr:has(td)'),
        $rows=$rows.slice(2);
            // Temporary delimiter characters unlikely to be typed by keyboard
            // This is to avoid accidentally splitting the actual contents
            tmpColDelim = String.fromCharCode(11), // vertical tab character
            tmpRowDelim = String.fromCharCode(0), // null character

            // actual delimiter characters for CSV format
            colDelim = '","',
            rowDelim = '"\r\n"',

            csv = '"거래시간","온도","GT가용량","CC가용량"\r\n"';
            // Grab text from table into CSV formatted string
            csv = csv + $rows.map(function (i, row) {
                var $row = $(row), $cols = $row.find('td');
                $cols = $cols.slice(0,3);
                return $cols.map(function (j, col) {
                    if(j==0){
                        var $col = $(col);
                        if(!$col.text().includes("+") && !$col.text().includes("-"))
                            var text = '[*'+$col.text()+']' +'","'+ temperature_col[i];
                        else{
                            var text = '['+$col.text()+']'+'","'+ temperature_col[i];
                        }



                    }else{
                        var $col = $(col), text = $col.text();
                    }
                    
                    // return text.replace(/"/g, '""'); // escape double quotes
                    return text; // escape double quotes

                }).get().join(tmpColDelim);

            }).get().join(tmpRowDelim)
                .split(tmpRowDelim).join(rowDelim)
                .split(tmpColDelim).join(colDelim) + '"',

            

            // Data URI
            csvData ='data:application/csv;charset=utf-8,' + encodeURIComponent('\uFEFF' + csv);


            if (window.navigator.msSaveBlob) { // IE 10+
                //alert('IE' + csv);
                window.navigator.msSaveOrOpenBlob(new Blob(['\uFEFF' + csv], {type: "text/csv;charset=utf-8;"}), filename)
            } 
            else {
                $(this).attr({ 'download': filename, 'href': csvData, 'target': '_blank' }); 
            }
        }

    var temperature_col;
    var data;
    var current_tab = "gt";
    var pressure = [];
    var gt_generate_name_list = [];
    var cc_generate_name_list = [];
    var gt_send_name_list = [];
    var cc_send_name_list = [];
    var _suffix=['-18','-19','-20','-21','-22','-23','00','01','02','03','04','05','06','07','08','09','10','11','12','13','14','15','16','17','18','19','20','21','22','23','-00','-01','-02','-03'];
    _suffix.forEach(function(element){
        gt_generate_name_list.push("#generated-power-gt-" + element);
        cc_generate_name_list.push("#generated-power-cc-" + element);
        gt_send_name_list.push("#send-power-gt-" + element);
        cc_send_name_list.push("#send-power-cc-" + element);       
    });
    d3.csv("static/data/inlet_clean_info.csv").then(function(data) {
            var today = new Date();
            var clean_time = data[0].cleaned_time;
            $("#nearest_cleaned_time").html(clean_time);

            var clean_time = data[0].cleaned_time.replace(/-/g,"/");
            clean_time = new Date(clean_time);
            var hours = Math.abs(today - clean_time) / 36e5;
            hours = Math.floor(hours*1000)/1000;
            document.getElementById("txt-cleaned-time").value= Math.floor(hours);
            $("#EOH").html(hours);


            var tested_power = data[0].tested_power_output;
            tested_power = Math.floor(tested_power*1000)/1000;
            $("#test_power").html(tested_power);
        });
        
    function removeDups(array) {
        let unique = {};
        array.forEach(function(i) {
            if(!unique[i]) {unique[i] = true;}
        });
        return Object.keys(unique)
    };

    function reset_table(){
        for(i=0;i<34;i++){
            $(gt_generate_name_list[i]).html("산출");
            $(cc_generate_name_list[i]).html("산출");
            $(gt_send_name_list[i]).html("산출");
            $(cc_send_name_list[i]).html("산출");
        };
    };

    function activeTabButton(evt, buttonName) {
        // Get all elements with class="tablinks" and remove the class "active"
        tablinks = document.getElementsByClassName("tab-button");
        for (i = 0; i < tablinks.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" tab-button-active", "");
        }
        evt.currentTarget.className += " tab-button-active";
    };
    $(function(){
        $("#csv").click(function(){
            document.getElementById("file").click();
        });
    });
    ///// trigger '산출' button to calculate
    $(function(){
        $('#ml-form_submit').click(function(){
            $("#warning-message").html("");
            if(form_validation()==true){
                // var user = $('#inputUsername').val();
                // var pass = $('#inputPassword').val();
                $.ajax({
                    url: '/ml-inference',
                    data: $('form').serialize(),
                    type: 'POST',
                    success: function(response){
                        /////////// successfully calculated/////////////////
                        data = JSON.parse(response);
                        temperature_col =  data.temperature;
                        for(i=0;i<34;i++){
                            $(gt_generate_name_list[i]).html(data.gt_generate_predicted[i]);
                            $(cc_generate_name_list[i]).html(data.cc_generate_predicted[i]);
                            $(gt_send_name_list[i]).html(data.gt_transfer_predicted[i]);
                            $(cc_send_name_list[i]).html(data.cc_transfer_predicted[i]);
                             /// returned pressure is a number, convert to array for plotting graph
                             pressure.push(data.pressure);
                        };
                        
                        if (current_tab=="gt"){
                            ////// draw power reduction graph
                            ////// draw power reduction graph
                            var power_reduction = data.power_reduction.slice(6,30).map(function(element){
                                return element / 1000
                            });
                            draw_power_reduction(power_reduction);
                            ////// draw generated power + temperature + barometric pressure graph
                            var power_min = Math.min.apply(null,data.gt_generate_predicted) - (Math.max.apply(null,data.gt_generate_predicted)/2 - Math.min.apply(null,data.gt_generate_predicted)/2);
                            draw_output(data.gt_generate_predicted.slice(6,30), data.temperature.slice(6,30), pressure.slice(6,30), power_min);
                        }else{
                            ////// draw power reduction graph
                            ////// draw power reduction graph
                            var power_reduction = data.power_reduction.slice(6,30).map(function(element){
                                return Math.floor(element*0.1) / 100;
                            });
                            draw_power_reduction(power_reduction);
                            ////// draw generated power + temperature + barometric pressure graph
                            var power_min = Math.min.apply(null,data.cc_generate_predicted) - (Math.max.apply(null,data.cc_generate_predicted)/2 - Math.min.apply(null,data.cc_generate_predicted)/2);
                            draw_output(data.cc_generate_predicted.slice(6,30), data.temperature.slice(6,30), pressure.slice(6,30), power_min);
                        }
                    },
                    error: function(error){
                        console.log(error);
                    }
                });
            }

        });
    });
    $(function(){
        $("#date-select").change(function(){
            temperature_col = null;
            var txts = document.getElementsByClassName("temperature-input-textbox");
            document.getElementById("txt-pressure").value="";
            for(i=0;i<txts.length;i++){
                txts[i].value="";
            }
            var select_element = document.getElementById("date-select");
            var opt = select_element.options[select_element.selectedIndex];
            
            ////load temperature from temperature.csv file
            d3.csv("static/data/temperature.csv").then(function(data) {
                var temps=[];
                var opt_date = new Date(opt.value.replace(/-/g,"/"));
                var press_;
                for (i=0;i<data.length;i++){
                    time_in_data = new Date(data[i].time.replace(/-/g,"/"));
                    
                    if(time_in_data.getMonth()==opt_date.getMonth()&& time_in_data.getFullYear()==opt_date.getFullYear()){
                        alert("ngay co trong database");
                        if((time_in_data - opt_date) / 36e5 / 24 ==-1){
                            temps.push(data[i].h15);
                            temps.push(data[i].h18);
                            temps.push(data[i].h21);
                        }else if ((time_in_data - opt_date) / 36e5 / 24 ==0){
                            temps.push(data[i].h0);
                            temps.push(data[i].h3);
                            temps.push(data[i].h6);
                            temps.push(data[i].h9);
                            temps.push(data[i].h12);
                            temps.push(data[i].h15);
                            temps.push(data[i].h18);
                            temps.push(data[i].h21);
                            press_= data[i].pressure;
                        }else if ((time_in_data - opt_date) / 36e5 / 24 ==1){
                            temps.push(data[i].h0);
                            temps.push(data[i].h3);
                            temps.push(data[i].h6);
                            break;
                        }
                    }else{
                        alert("ngay khong co trong data");
                        /// load data from medium-term-temperature
                    }
                }
                
                for(i=0;i<temps.length;i++){
                    txts[i].value=temps[i];
                }
                if(press_ != null){
                    document.getElementById("txt-pressure").value=press_;
                }
            });

            
        });
    });

    $(function(){
        $('#form_submit').click(function(){
            $("#warning-message").html("");
            
            if(form_validation()==true){
                // var user = $('#inputUsername').val();
                // var pass = $('#inputPassword').val();
                $.ajax({
                    url: '/inference',
                    data: $('form').serialize(),
                    type: 'POST',
                    success: function(response){
                        /////////// successfully calculated/////////////////
                        data = JSON.parse(response);
                        temperature_col =  data.temperature;
                        
                        for(i=0;i<34;i++){
                            $(gt_generate_name_list[i]).html(data.gt_generate_predicted[i]);
                            $(cc_generate_name_list[i]).html(data.cc_generate_predicted[i]);
                            $(gt_send_name_list[i]).html(data.gt_transfer_predicted[i]);
                            $(cc_send_name_list[i]).html(data.cc_transfer_predicted[i]);
                            /// returned pressure is a number, convert to array for plotting graph
                            pressure.push(data.pressure);
                        };
                        if (current_tab=="gt"){
                            ////// draw power reduction graph
                            ////// draw power reduction graph
                            var power_reduction = data.power_reduction.slice(6,30).map(function(element){
                                return element / 1000
                            });
                            draw_power_reduction(power_reduction);
                            ////// draw generated power + temperature + barometric pressure graph
                            var power_min = Math.min.apply(null,data.gt_generate_predicted) - (Math.max.apply(null,data.gt_generate_predicted)/2 - Math.min.apply(null,data.gt_generate_predicted)/2);
                            draw_output(data.gt_generate_predicted.slice(6,30), data.temperature.slice(6,30), pressure.slice(6,30), power_min);
                        }else{
                            ////// draw power reduction graph
                            ////// draw power reduction graph
                            var power_reduction = data.power_reduction.slice(6,30).map(function(element){
                                return element / 1000
                            });
                            draw_power_reduction(power_reduction);
                            ////// draw generated power + temperature + barometric pressure graph
                            var power_min = Math.min.apply(null,data.cc_generate_predicted) - (Math.max.apply(null,data.cc_generate_predicted)/2 - Math.min.apply(null,data.cc_generate_predicted)/2);
                            draw_output(data.cc_generate_predicted.slice(6,30), data.temperature.slice(6,30), pressure.slice(6,30), power_min);
                        }
                        
                    },
                    error: function(error){
                        console.log(error);
                    }
                });
            }
        });
    }); 

    function monthDiff(dateFrom, dateTo) {
        return dateTo.getMonth() - dateFrom.getMonth() + (12 * (dateTo.getFullYear() - dateFrom.getFullYear()))
    };

    $(function gt_tab_selected(){
        $("#tab-GT").click(function(){
            current_tab = "gt";
        
            ///// get historical data to draw the send_power chart
            //// selected date
            var select_element = document.getElementById("date-select");
            var opt = select_element.options[select_element.selectedIndex];
            //// get data which is within 5 month from now
            var dates = [];
            var months = [];
            var gt1= [],gt2= [],gt3= [],gt4= [],gt5 = [];
            var today = new Date();
            var lastday_of_month = new Date(today.getFullYear(), today.getMonth()+1, 0);
            d3.csv("static/data/log_data.csv").then(function(data) {
                
                for(i=0;i<data.length;i++){
                    temp = data[i].time.replace(/-/g,"/")
                    date = new Date(temp);

                    diff = monthDiff(lastday_of_month, date);
                    if(diff>=-1){
                        dates.push(date.getFullYear()+"-"+(date.getMonth()+1)+date.getDate());
                        months.push(date.getFullYear()+"-"+(date.getMonth()+1));
                        gt1.push(data[i].GT);
                    } else if(diff>=-2){
                        dates.push(date.getFullYear()+"-"+(date.getMonth()+1)+date.getDate());
                        months.push(date.getFullYear()+"-"+(date.getMonth()+1));
                        gt2.push(data[i].GT);
                    }else if(diff>=-3){
                        dates.push(date.getFullYear()+"-"+(date.getMonth()+1)+date.getDate());
                        months.push(date.getFullYear()+"-"+(date.getMonth()+1));
                        gt3.push(data[i].GT);
                    }else if(diff>=-4){
                        dates.push(date.getFullYear()+"-"+(date.getMonth()+1)+date.getDate());
                        months.push(date.getFullYear()+"-"+(date.getMonth()+1));
                        gt4.push(data[i].GT);
                    }else if(diff>=-5){
                        dates.push(date.getFullYear()+"-"+(date.getMonth()+1)+date.getDate());
                        months.push(date.getFullYear()+"-"+(date.getMonth()+1));
                        gt5.push(data[i].GT);
                    }
                }

                ////convert to number
                gt1 = gt1.map(function (x) { return parseFloat(x)});
                gt2 = gt2.map(function (x) { return parseFloat(x)});
                gt3 = gt3.map(function (x) { return parseFloat(x)});
                gt4 = gt4.map(function (x) { return parseFloat(x)});
                gt5 = gt5.map(function (x) { return parseFloat(x)});
                
                var log_1 = sum(gt1);
                var log_2 = sum(gt2);
                var log_3 = sum(gt3);
                var log_4 = sum(gt4);
                var log_5 = sum(gt5);

                var passive_power_1 = 6 * gt1.length;
                var passive_power_2 = 6 * gt2.length;
                var passive_power_3 = 6 * gt3.length;
                var passive_power_4 = 6 * gt4.length;
                var passive_power_5 = 6 * gt5.length;

                draw_summary_graph(removeDups(months),[log_5,log_4,log_3,log_2,log_1],[passive_power_5,passive_power_4,passive_power_3,passive_power_2,passive_power_1]);
            });
            if (data==null){
                alert("먼저 산출하세요!");
            }
            ////// draw generated power + temperature + barometric pressure graph
            var power_min = Math.min.apply(null,data.gt_generate_predicted) - (Math.max.apply(null,data.gt_generate_predicted)/2 - Math.min.apply(null,data.gt_generate_predicted)/2);
            draw_output(data.gt_generate_predicted.slice(6,30), data.temperature.slice(6,30), pressure.slice(6,30), power_min);
            
        });
    });

    function mean(array){
        var sum=0;
        for(i=0;i<array.length;i++){
            sum+=array[i];
        }
        return sum/array.length
    }

    function sum(array){
        var sum=0;
        for(i=0;i<array.length;i++){
            sum+=array[i];
        }
        return sum
    }

    $(function(){
        
        $("#file").change(function(){
            if(check_ext()){
                var form_data = new FormData($("#form")[0]);
                
                $.ajax({
                    url: '/uploadss',
                    // data: $('form').serialize(),
                    data: form_data,
                    type: 'POST',
                    contentType: false,
                    cache: false,
                    processData: false,
                    async: false,
                    success: function(response){
                        if(response == "file uploaded successfully"){
                            alert("정상 처리 되었습니다.");
                        }else if (response =="filename is not acceptable"){
                            alert("파일 이름 일치하지 않기로 파일 업데이드 실패하였습니다");
                        }
                        
                        var txts = document.getElementsByClassName("temperature-input-textbox");
                        document.getElementById("txt-pressure").value="";
                        for(i=0;i<txts.length;i++){
                            txts[i].value="";
                        }
                        var select_element = document.getElementById("date-select");
                        var opt = select_element.options[select_element.selectedIndex];
                        
                        d3.csv("static/data/temperature.csv").then(function(data) {
                            var temps=[];
                            var press_;
                            var opt_date = new Date(opt.value.replace(/-/g,"/"));
                            for (i=0;i<data.length;i++){
                                time_in_data = new Date(data[i].time.replace(/-/g,"/"));

                                if(time_in_data.getMonth()==opt_date.getMonth()&& time_in_data.getFullYear()==opt_date.getFullYear()){
                                    if((time_in_data - opt_date) / 36e5 / 24 ==-1){
                                       temps.push(data[i].h15);
                                       temps.push(data[i].h18);
                                       temps.push(data[i].h21);
                                    }else if ((time_in_data - opt_date) / 36e5 / 24 ==0){
                                        temps.push(data[i].h0);
                                        temps.push(data[i].h3);
                                        temps.push(data[i].h6);
                                        temps.push(data[i].h9);
                                        temps.push(data[i].h12);
                                        temps.push(data[i].h15);
                                        temps.push(data[i].h18);
                                        temps.push(data[i].h21);
                                        press_=data[0].pressure;
                                    }else if ((time_in_data - opt_date) / 36e5 / 24 ==1){
                                        temps.push(data[i].h0);
                                        temps.push(data[i].h3);
                                        temps.push(data[i].h6);
                                        break;
                                    }
                                }
                            }

                            for(i=0;i<temps.length;i++){
                                txts[i].value=temps[i];
                            }
                            document.getElementById("txt-pressure").value=press_;
                        });
                    },
                    error: function(error){
                        console.log(error);
                    }
                });
            }
        });
    });
    
    $(function cc_tab_selected(){
        $("#tab-CC").click(function(){
            current_tab="cc";
            

            ///// get historical data to draw the send_power chart
            //// selected date
            var select_element = document.getElementById("date-select");
            var opt = select_element.options[select_element.selectedIndex];
            //// get data which is within 5 month from now
            var dates = [];
            var months= [];
            var cc1= [],cc2= [],cc3= [],cc4= [],cc5 = [];
            var today = new Date();
            var lastday_of_month = new Date(today.getFullYear(), today.getMonth()+1, 0);
            d3.csv("static/data/log_data.csv").then(function(data) {
                for(i=0;i<data.length;i++){
                    temp = data[i].time.replace(/-/g,"/")
                    date = new Date(temp);
                    diff = monthDiff(lastday_of_month, date);
                    if(diff>=-1){
                        dates.push(date.getFullYear()+"-"+(date.getMonth()+1)+date.getDate());
                        months.push(date.getFullYear()+"-"+(date.getMonth()+1));
                        cc1.push(data[i].CC);
                    } else if(diff>=-2){
                        dates.push(date.getFullYear()+"-"+(date.getMonth()+1)+date.getDate());
                        months.push(date.getFullYear()+"-"+(date.getMonth()+1));
                        cc2.push(data[i].CC);
                    }else if(diff>=-3){
                        dates.push(date.getFullYear()+"-"+(date.getMonth()+1)+date.getDate());
                        months.push(date.getFullYear()+"-"+(date.getMonth()+1));
                        cc3.push(data[i].CC);
                    }else if(diff>=-4){
                        dates.push(date.getFullYear()+"-"+(date.getMonth()+1)+date.getDate());
                        months.push(date.getFullYear()+"-"+(date.getMonth()+1));
                        cc4.push(data[i].CC);
                    }else if(diff>=-5){
                        dates.push(date.getFullYear()+"-"+(date.getMonth()+1)+date.getDate());
                        months.push(date.getFullYear()+"-"+(date.getMonth()+1));
                        cc5.push(data[i].CC);
                    }
                }

                ////convert to number
                cc1 = cc1.map(function (x) { return parseFloat(x)});
                cc2 = cc2.map(function (x) { return parseFloat(x)});
                cc3 = cc3.map(function (x) { return parseFloat(x)});
                cc4 = cc4.map(function (x) { return parseFloat(x)});
                cc5 = cc5.map(function (x) { return parseFloat(x)});
                
                var log_1 = sum(cc1);
                var log_2 = sum(cc2);
                var log_3 = sum(cc3);
                var log_4 = sum(cc4);
                var log_5 = sum(cc5);

                var passive_power_1 = 6 * cc1.length;
                var passive_power_2 = 6 * cc2.length;
                var passive_power_3 = 6 * cc3.length;
                var passive_power_4 = 6 * cc4.length;
                var passive_power_5 = 6 * cc5.length;
                

                draw_summary_graph(removeDups(months),[log_5,log_4,log_3,log_2,log_1],[passive_power_5,passive_power_4,passive_power_3,passive_power_2,passive_power_1]);
            });
            if (data==null){
                alert("먼저 산출하세요!");
            }
            ///// redraw graph
            ////// draw generated power + temperature + barometric pressure graph
            var power_min = Math.min.apply(null,data.cc_generate_predicted) - (Math.max.apply(null,data.cc_generate_predicted)/2 - Math.min.apply(null,data.cc_generate_predicted)/2);
            draw_output(data.cc_generate_predicted.slice(6,30), data.temperature.slice(6,30), pressure.slice(6,30), power_min);

            
        });
    });
    ///form validatioon function
    function form_validation(){
        var textbox_list = document.getElementsByClassName('temperature-input-textbox');
        var array=[];
        var error = true;
        for (i=0;i<textbox_list.length;i++){
            array.push(textbox_list[i]);
        }
        array.forEach(function(element) {
            if (element.value==''){
                $("#warning-message").html("* 온도를 입력해 주세요!");
                error = false;
            }else if(-50>element.value || element.value>70){
                $("#warning-message").html("* 온도는 -50~70도 입니다!");
                error = false;
            }
        });
        
        var textbox_pressure = document.getElementById("txt-pressure");
        if (800>textbox_pressure.value || textbox_pressure.value>1200){
            $("#warning-message").html("* 대기압은 800~1200 mbar 입니다!");
            error = false;
        }else if (textbox_pressure.value==""){
            $("#warning-message").html("* 대기압을 입력해 주세요!");
            error = false;
        }
        var textbox_cleaned_time = document.getElementById("txt-cleaned-time");
        if (textbox_cleaned_time.value<0){
            $("#warning-message").html("* 수세정후 시간은 음수 아닙니다!");
            error = false;
        }else if (textbox_cleaned_time.value==""){
            $("#warning-message").html("* 수세정후 시간을 입력해 주세요!");
            error = false;
        }
        return error
    };



    //checking for valid number 
    $(document).on('change', '.temperature-input-textbox', function() { 
        var input_value = parseFloat($(this).val());
        if(isNaN(input_value)) { input_value = 0; }
        $(this).val(input_value);
    });
    $(document).on('change', '.textbox-input', function() { 
        var input_value = parseFloat($(this).val());
        if(isNaN(input_value)) { input_value = 0; }
        $(this).val(input_value);
    });
    
    //checking for valid number 
    $(document).on('focus', '.temperature-input-textbox', function() {
        $(this).val('');
    });
    $(document).on('focus', '#txt-pressure', function() { 
        $(this).val('');
    });

    ////function display the realtime clock
    function display_time(){
        var interval=1000 /// 1second interval;
        time = setTimeout('display_clock()',interval)
    };


    function display_clock(){
        var date = new Date();
        time = pad2(date.getHours( ))+ ":" +  pad2(date.getMinutes()) + ":" +  pad2(date.getSeconds());
        $('#clock').html(time)
        display_time();
    };

    
    //// function to add 0 ahead of single number
    function pad2(number) {
        return (number < 10 ? '0' : '') + number
    };

    //// create a list of dates from startDate to endDate
    var today = new Date();
    //var startDate = new Date(today.getFullYear(), 0, 1);
    var startDate = today;
    var endDate = new Date(today.getFullYear(),today.getMonth(),today.getDate()+72); //YYYY-MM-DD
    //// function to generate dates list
    var getDateArray = function(start, end) {
        var arr = new Array();
        var dt = new Date(start);
        while (dt <= end) {
            arr.push(new Date(dt).toISOString().split("T")[0]);
            dt.setDate(dt.getDate() + 1);
        }
        /// add the last day of year
        arr.push(new Date(dt).toISOString().split("T")[0]);
        return arr
    }
    //// listup the dates
    datesList = getDateArray(startDate, endDate);
    ///// generate tables
    $(document).ready(function(){
        $("#export-to-csv-button").click(function(){
            if (temperature_col==null){
                alert("먼저 산출하세요!");
                return;
            }else{
                document.getElementById("export-to-csv").click();
            }
            
        });
        $("#export-to-csv").on('click', function (event) {
            var selected_date = document.getElementById("date-select").value.replace(/-/g,"")
            var filename = "붙임1. bid_2637_" + selected_date + ".csv";
            exportTableToCSV.apply(this, [$('#data-table'),temperature_col, filename]);
        });
        
        var date = new Date();
        year = date.getFullYear();
        month= date.getMonth()+1;
        day=date.getDate();
        weekday = date.getDay();
        if (weekday==1){
            wd ='월요일'
        }else if (weekday==2){
            wd ='화요일'
        }else if (weekday==3){
            wd ='수요일'
        }else if (weekday==4){
            wd ='목요일'
        }else if (weekday==5){
            wd ='금요일'
        }else if (weekday==6){
            wd ='토요일'
        }else{
            wd ='일요일'
        }
        $('#div-info-date').html(year +'년 '+month+'월'+day+'일, ' + wd);
        today = pad2(year)+"-"+pad2(month)+"-"+pad2(day)
        // $('#date-select').empty();
        $.each(datesList, function(i, p) {
            if (today === p){
                $('#date-select').append($('<option selected="selected"></option>').val(p).html(p));
            }else{
                $('#date-select').append($('<option></option>').val(p).html(p));
            }
        });

        //// draw calculated table
        table_body = ""
        hour = 17
        for(i=0;i<34;i++){
                hour +=1
                if(Math.floor(hour/24)<1){
                    table_body+="<tr><td>-"+pad2(hour%24)+"01</td><td class='tesst' name='send-power-gt--"+pad2(hour%24)+"' id='send-power-gt--"+pad2(hour%24)+"'>산출</td><td name='send-power-cc--"+pad2(hour%24)+"' id='send-power-cc--"+pad2(hour%24)+"'>산출</td><td>-"+pad2(hour%24)+"01</td><td name='generated-power-gt--"+pad2(hour%24)+"' id='generated-power-gt--"+pad2(hour%24)+"'>산출</td><td name='generated-power-cc--"+pad2(hour%24)+"' id='generated-power-cc--"+pad2(hour%24)+"'>산출</td></tr>"        
                }else if(Math.floor(hour/24)==1){
                    table_body+="<tr><td>"+pad2(hour%24)+"01</td><td name='send-power-gt-"+pad2(hour%24)+"' id='send-power-gt-"+pad2(hour%24)+"'>산출</td><td name='send-power-cc-"+pad2(hour%24)+"' id='send-power-cc-"+pad2(hour%24)+"'>산출</td><td>"+pad2(hour%24)+"01</td><td name='generated-power-gt-"+pad2(hour%24)+"' id='generated-power-gt-"+pad2(hour%24)+"'>산출</td><td name='generated-power-cc-"+pad2(hour%24)+"' id='generated-power-cc-"+pad2(hour%24)+"'>산출</td></tr>"        
                }else{
                    table_body+="<tr><td>+"+pad2(hour%24)+"01</td><td name='send-power-gt-+"+pad2(hour%24)+"' id='send-power-gt--"+pad2(hour%24)+"'>산출</td><td name='send-power-cc-+"+pad2(hour%24)+"' id='send-power-cc--"+pad2(hour%24)+"'>산출</td><td>+"+pad2(hour%24)+"01</td><td name='generated-power-gt-+"+pad2(hour%24)+"' id='generated-power-gt--"+pad2(hour%24)+"'>산출</td><td name='generated-power-cc-+"+pad2(hour%24)+"' id='generated-power-cc--"+pad2(hour%24)+"'>산출</td></tr>"        
                }
            };
        $('#generated-output-data').html(table_body);

            ////// draw temperature table
        table_body = "" 
        hour = 12
        for(i=0;i<14;i++){
                hour +=3
                if(Math.floor(hour/24)<1){
                    table_body+="<tr><td width='20%'>-"+pad2(hour%24)+"</td><td><input name='input-temp--"+pad2(hour%24)+"' class='temperature-input-textbox' type='text' placeholder='입력온도'/></td></tr>"            
                }else if(Math.floor(hour/24)==1){
                    table_body+="<tr><td width='20%'>"+pad2(hour%24)+"</td><td><input name='input-temp-"+pad2(hour%24)+"' class='temperature-input-textbox' type='text' placeholder='입력온도'/></td></tr>"            
                }else{
                    table_body+="<tr><td width='20%'>+"+pad2(hour%24)+"</td><td><input name='input-temp--"+pad2(hour%24)+"' class='temperature-input-textbox' type='text' placeholder='입력온도'/></td></tr>"            
                }
            };
        $('#input-temperature').html(table_body);
    });

    function check_ext(){
        var regexp;
        var file_element = document.getElementById("file")
        var extension =     file_element.value.substr(file_element.value.lastIndexOf('.'));
        if ((extension.toLowerCase() != ".csv") && (extension != "")){
            alert("csv 포맷만 업로드 가능");
            theForm.file.focus();
            return false;
        }
        return true;
    }



</script>
</head>
<body onload=display_time();>
<div id="wrapper">
    <!-- left container-->
    <div id="left-container">
        <div id="div-logo">
            <img src="static/icons/kospo_logo.png" width="100%" height ="auto"/>
        </div>
        <hr/><hr/><hr/>
        <div id="div-system-infos">
                <div id="div-info-station">
                        <span style="display:block;font-weight:bolder; font-size:xx-large; color:rgb(188, 238, 89)">안동복합화력</span>
                        <span style="display:block;font-weight:bolder; font-size:xx-large; color:rgb(188, 238, 89)">발전소</span>
                </div>
                <hr/>
                <div id="div-info-date">
                    Systenm's info
                </div>
                <hr/>
                <div id="div-info-clock">
                    <span>현재시간:</span>
                    <span id="clock"></span>
                </div>
                <!-- <hr/>
                <div id="div-info-cleaned-hour">
                    <span >EHB:</span>
                    <span id="system_operation_time" style="color:yellow; padding:5px"></span>
                </div> -->
                <hr/>
                <div id="div-info-nearest-clean-time">
                    <span>최근 수세정:</span>
                    <span id="nearest_cleaned_time" ></span>
                </div>
        </div>
        <hr/>
        <div id="div-menu-items">
                <div class="info" style="margin-top: 30px">
                    <div width="100%">수세정후 시험 출력 (MW) </div>
                    <div class="text-temp">
                        <div id="test_power"></div>
                    </div>
                        
                </div>
    
    
                <div class="info" style="margin-top: 30px">
                    <div width="100%"> 수세정후 시간 (Hours) </div>
                    <div class="text-temp">
                        <div id="EOH"></div>
                    </div>
                    
                </div>
            
    
        </div>
    </div>


    <!-- right container-->
    <div id="graph-container">
        <div id="graph-upper-container" style="max-height:321px">
            <form role="form" id="form" name="input_form" method="POST" enctype="multipart/form-data">
                    <div class="div-input" id="div-date-input">
                        <div class="upper-input"> <select id="date-select" name="date-select"></select></div>
                        <div id="div-temperature-input" class="lower-element">
                            <table class="table-input table" id="table-temperature-input">
                                <thead>
                                    <tr>
                                        <td><span style="font-weight: bold;">시간</span></td>
                                        <td><span style="font-weight: bold;">온도</span></td>
                                    </tr>
                                </thead>
                                <tbody id="input-temperature">
                                    
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="div-output" id="div-power-output-wrapper">
                        <div class="upper-input" id="div-pressure-cleaned-input">
                            <div id="div-pressure-input" style="float:left;margin: 0 10px; max-width: 20%;" >
                                <span class="label-input">대기압 (mbar):</span> 
                                <input name="txt-pressure" id="txt-pressure" class="textbox-input" type="text"/>
                            </div>
                            <div id="div-cleaned-time-input" style="float:left;margin: 0 10px;max-width: 20%;">
                                <span class="label-input">수세정후 시간 (hr):</span> 
                                <input name="txt-cleaned-time" id="txt-cleaned-time" readonly="true" class="textbox-input" type="text"/>
                            </div>
                            <div style="float:left; height:100%">
                                <input name="file" type="file" id="file" style="display:none;" accept=".csv"/>
                                <button class="button" type="button" name="csv" id="csv">파일 업로드</button>
                                <button class="button" type="reset" name="reset" onclick="reset_table();">다시 입력</button>
                                <button class="button" type="button" name="ml-submit" id="ml-form_submit">ML 산출</button>
                                <button class="button" type="button" name="submit" id="form_submit">수식 산출</button>
                                <button class="button" type="button" name="export" id="export-to-csv-button">csv 생성</button>
                                <a href="#" id="export-to-csv" style="display:none"></a>
                            </div>
                            
                        </div>
                        <div id="div-power-output" class="lower-element">
                            <table class="data-table table" id="data-table" >
                                <thead>
                                    <tr><td><span style="font-weight: bold;">송전단</span></td><td colspan="2"><span style="font-weight: bold;">가용량</span></td><td><span style="font-weight: bold;">발전단</span></td><td colspan="2"><span style="font-weight: bold;">가용량</span></td></tr>
                                    <tr><td><span style="font-weight: bold;">거래시간</span></td><td><span style="font-weight: bold;">GT</span></td><td><span style="font-weight: bold;">CC</span></td><td><span style="font-weight: bold;">거래시간</span></td><td><span style="font-weight: bold;">GT</span></td><td><span style="font-weight: bold;">CC</span></td></tr>
                                </thead>
                                <tbody id="generated-output-data">
                                </tbody>
                            </table>
                        </div>
                    </div>
            </form>
        </div>
        <div id="graph-lower-container" style="max-height:582px">
            <!-- container of 발전-송전 그림과 출력저하 그림-->
            <div id="left-graph-container" style="height:auto">
                <div class="button-inlet-type"><button class="tab-button" id="tab-GT" onclick="activeTabButton(event, 'GT')">GT</button><button class="tab-button" id="tab-CC" onclick="activeTabButton(event, 'CC')">CC</button></div>
                <div style="display:inline-block; width:100%;">
                    <div id="div-generated-graph" class="graph" style="width:95%; height:250px;">발전-송전 그림</div>
                    <div id="div-power-loss-graph" class="graph" style="width:95%; height:250px;">출력저하 그림</div>
                </div>
                
            </div>
            <div id="right-graph-container" style="height: auto"> 
                <!-- container of 산출 발전량 그림-->
                <div class="button-inlet-type">
                        <span id='warning-message'></span>
                </div>
                <div id="div-calculated-output-graph">산출 발전량 그림</div>
            </div>
        </div>
    </div>
</div>



<!-- draw highchart graphs-->
<script>
    /// Highcharts injection modules
    
    //// data
    // var output=[428.6349792,428.6349792,429.3438721,428.2450562,427.8551636,427.8551636,428.4931946,428.4931946,428.9539795,428.5995178,427.6070557,427.6070557,428.8476563,428.8476563,429.3084412,429.3084412,428.6704102,428.6704102,428.6349792,428.6349792,428.6349792,428.6349792,428.7058716,428.7058716,428.6349792,428.6349792,429.1666565,429.1666565,428.9539795,428.2096252,428.2096252,428.0678406,428.2096252,429.3438721,429.1666565,428.2096252,428.4577332,428.6349792,428.6349792,428.5995178,428.4223022,427.8197327,427.890625,427.890625,428.4223022,427.9969482,428.9539795,428.4931946,428.4931946,428.4931946] /// generated power output
    var output=[428.6349792,428.6349792,429.3438721,428.2450562,427.8551636,427.8551636,428.4931946,428.4931946,428.9539795,428.5995178,427.6070557,427.6070557,428.8476563,428.8476563,429.3084412,429.3084412,428.6704102,428.6704102,428.6349792,428.6349792,428.6349792,428.6349792,428.7058716] /// generated power output
    var output_2 = output.map( function(value) {return value - Math.floor(Math.random() * 2) -3});
    var time=[]
    var temperature = [-0.379047394,-0.379047394,-0.379047394,-0.379047394,-0.379047394,-0.379047394,-0.379047394,-0.379047394,-0.379047394,-0.379047394,-0.379047394,-0.379047394,-0.379047394,-0.379047394,-0.379047394,-0.379047394,-0.379047394,-0.379047394,-0.379047394,-0.379047394,-0.379047394,-0.379047394,-0.379047394,-0.379047394,-0.379047394,-0.379047394,-0.379047394,-0.379047394,-0.379047394,-0.379047394,-0.379047394,-0.379047394,-0.379047394,-0.379047394,-0.379047394,-0.379047394,-0.379047394,-0.379047394,-0.379047394,-0.379047394,-0.379047394,-0.379047394,-0.379047394,-0.379047394,-0.379047394,-0.379047394,-0.379047394,-0.379047394,-0.379047394,-0.379047394]

    output = output.map(function (x) { return parseFloat(x)})
    temperature = temperature.map(function (x) { return parseFloat(x)})

    /// draw lost power graph
    function draw_power_reduction(power_reduction_serie){
        Highcharts.chart('div-power-loss-graph', {
            chart: {
                type: 'line',
                style:{
                    fontFamily:'sans-serif'
                }
            },
            title: {
                text: '출력저하',
                style:{
                    fontWeight:'Bold'
                }
            },
            xAxis: {
                categories: ['0시', '1시', '2시', '3시', '4시', '5시','6시', '7시', '8시', '9시', '10시', '11시', '12시', '13시', '14시', '15시', '16시', '17시', '18시', '19시', '20시', '21시', '22시', '23시']
            },
            yAxis: {
                title: {
                    text: '전력 (MW)'
                }
            },
            tooltip: {
                headerFormat: '<b>출력 저하량</b><br/>',
                pointFormat: '{series.name}: {point.y}'
            },
            plotOptions: {
                line: {
                dataLabels: {
                    enabled: true,
                    formatter: function () {
                        return parseFloat(this.y.toFixed(2)).toLocaleString()
                    }
                },
                enableMouseTracking: false
                }
            },
            series: [{
                name: '산출 출력저하',
                data: power_reduction_serie,
            }]
        });
    };

    function draw_summary_graph(cats, send_power, passive_power){
        
        /// draw generated output and sent power
        Highcharts.chart('div-generated-graph', {
            chart: {
                type: 'column',
                style:{
                    fontFamily:'sans-serif'
                },
            },
            title: {
                text: '최근 5개월 송전량',
                style:{
                    fontWeight:'Bold',
                },
            },
            xAxis: {
                categories: cats,
            },
            yAxis: {
                min: 0,
                title: {
                    text: '전력 (MW)',
                },
                stackLabels: {
                    enabled: true,
                    style: {
                        fontWeight: 'bold',
                        color: (Highcharts.theme && Highcharts.theme.textColor) || 'gray',
                    },
                    formatter: function () {
                        return parseFloat(this.total.toFixed(2)).toLocaleString()
                    },
                },
            },
            legend: {
                align: 'right',
                x: -30,
                verticalAlign: 'top',
                y: 25,
                floating: true,
                backgroundColor: (Highcharts.theme && Highcharts.theme.background2) || 'white',
                borderColor: '#CCC',
                borderWidth: 1,
                shadow: false,
            },
            tooltip: {
                headerFormat: '<b>{point.x}</b><br/>',
                pointFormat: '{series.name}: {point.y}<br/>Total: {point.stackTotal}',
            },
            plotOptions: {
                column: {
                    stacking: 'normal',
                    dataLabels: {
                        enabled: true,
                        color: (Highcharts.theme && Highcharts.theme.dataLabelsColor) || 'white',
                        formatter: function () {
                            return parseFloat(this.y.toFixed(2)).toLocaleString()
                        },
                    },
                }
            },
            series: [{
                color:'#444000',
                name: '송전량',
                data: send_power,
            }, {
                color: '#33aaef',
                name: '소내소비동력',
                data: passive_power,
            },
            ],
        });
    };
        
    function draw_output(serie_1, serie_2, serie_3, power_min){
        //// draw output graph
        Highcharts.chart('div-calculated-output-graph', {
            chart: {
                zoomType: 'xy',
                style:{
                    fontFamily:'sans-serif'
                }
            },
            plotOptions: {
                column: {
                    stacking: 'normal',
                    dataLabels: {
                        enabled: true,
                        formatter: function () {
                            return parseFloat(this.y.toFixed(2)).toLocaleString()
                        }
                    }
                }
            },
            title: {
                text: '산출 발전량',
                align: 'center',
                style:{
                    fontWeight:'Bold'
                }
            },
            xAxis: [{
                categories: ['0시', '1시', '2시', '3시', '4시', '5시','6시', '7시', '8시', '9시', '10시', '11시', '12시', '13시', '14시', '15시', '16시', '17시', '18시', '19시', '20시', '21시', '22시', '23시'],
                crosshair: true
            }],
            yAxis: [{ // Primary yAxis
                labels: {
                    format: '{value}°C',
                    style: {
                        color: Highcharts.getOptions().colors[2]
                    }
                },
                title: {
                    text: '온도',
                    style: {
                        color: Highcharts.getOptions().colors[2]
                    }
                },
                opposite: true

            }, { // Secondary yAxis
                min: power_min,
                gridLineWidth: 0,
                title: {
                    text: '발전량',
                    style: {
                        color: Highcharts.getOptions().colors[0]
                    }
                },
                labels: {
                    format: '{value} MW',
                    style: {
                        color: Highcharts.getOptions().colors[0]
                    },
                    shadow: false,
                    enabled: false,
                }

            }, { // Tertiary yAxis
                gridLineWidth: 0,
                title: {
                    text: '대기압',
                    style: {
                        color: Highcharts.getOptions().colors[1]
                    },
                    shadow: false
                },
                labels: {
                    format: '{value} mb',
                    style: {
                        color: Highcharts.getOptions().colors[1]
                    },
                    shadow: false
                },
                opposite: true
            }],
            tooltip: {
                shared: true
            },
            legend: {
                layout: 'vertical',
                align: 'left',
                x: 80,
                verticalAlign: 'top',
                y: 55,
                floating: true,
                backgroundColor: (Highcharts.theme && Highcharts.theme.legendBackgroundColor) || 'rgba(255,255,255,0.25)',
                shadow: false
            },
            series: [{
                name: '발전출력',
                type: 'column',
                yAxis: 1,
                data: serie_1,
                tooltip: {
                valueSuffix: ' MW'
                }

            }, {
                name: '대기압',
                type: 'spline',
                yAxis: 2,
                data: serie_3,
                marker: {
                enabled: false
                },
                dashStyle: 'shortdot',
                tooltip: {
                valueSuffix: ' mbar'
                }

            }, {
                name: '온도',
                type: 'spline',
                data: serie_2,
                tooltip: {
                valueSuffix: ' °C'
                }
            }],
            responsive: {
                rules: [{
                condition: {
                    maxWidth: 500
                },
                chartOptions: {
                    legend: {
                    floating: false,
                    layout: 'horizontal',
                    align: 'center',
                    verticalAlign: 'bottom',
                    x: 0,
                    y: 0
                    }
                }
                }]
            }
        });
    };


    var serie_1=[409.9, 341.5, 350.4, 419.2, 402.0, 421.0, 435.6, 417.5, 411.4, 434.1, 375.6, 350.4,409.9, 341.5, 350.4, 419.2, 402.0, 421.0, 435.6, 417.5, 411.4, 434.1, 375.6, 350.4];
    var serie_2=[7.0, 6.9, 7.5, 7.5, 8.2,  8.3, 9.3, 11.9,15.2, 16.5, 16.3, 18.3, 19.6,17.0, 18.9, 17.5, 14.5, 13.2, 13.5,  12.9,11.5, 9.2, 8.5, 7.6];
    var serie_3=[1016, 1016, 1015.9, 1015.5, 1012.3, 1009.5, 1009.6, 1010.2, 1013.1, 1016.9, 1018.2, 1016.7,1016, 1016, 1015.9, 1015.5, 1012.3, 1009.5, 1009.6, 1010.2, 1013.1, 1016.9, 1018.2, 1016.7];
    
    draw_power_reduction([2.7,3.9,4.2,4.8,5.7,6.6,6.9,8.5,9.5,9.6,10.3,11.9,13.9,14.2,14.5,15.2,16.6,17,18.3,18.4,21.5,23.3,25.2,26.5])
    draw_output(serie_1, serie_2, serie_3, 370);
    

    
    ///// get historical data to draw the send_power chart
    //// selected date
    var select_element = document.getElementById("date-select");
    var opt = select_element.options[select_element.selectedIndex];
    //// get data which is within 5 month from now
    var dates = [];
    var months = [];
    var gt1= [],gt2= [],gt3= [],gt4= [],gt5 = [];
    var today = new Date();
    var lastday_of_month = new Date(today.getFullYear(), today.getMonth()+1, 0);
    d3.csv("static/data/log_data.csv").then(function(data) {
        for(i=0;i<data.length;i++){
            temp = data[i].time.replace(/-/g,"/")
            date = new Date(temp);
            diff = monthDiff(lastday_of_month, date);
            if(diff>=-1){
                dates.push(date.getFullYear()+"-"+(date.getMonth()+1)+date.getDate());
                months.push(date.getFullYear()+"-"+(date.getMonth()+1));
                gt1.push(data[i].GT);
            } else if(diff>=-2){
                dates.push(date.getFullYear()+"-"+(date.getMonth()+1)+date.getDate());
                months.push(date.getFullYear()+"-"+(date.getMonth()+1));
                gt2.push(data[i].GT);
            }else if(diff>=-3){
                dates.push(date.getFullYear()+"-"+(date.getMonth()+1)+date.getDate());
                months.push(date.getFullYear()+"-"+(date.getMonth()+1));
                gt3.push(data[i].GT);
            }else if(diff>=-4){
                dates.push(date.getFullYear()+"-"+(date.getMonth()+1)+date.getDate());
                months.push(date.getFullYear()+"-"+(date.getMonth()+1));
                gt4.push(data[i].GT);
            }else if(diff>=-5){
                dates.push(date.getFullYear()+"-"+(date.getMonth()+1)+date.getDate());
                months.push(date.getFullYear()+"-"+(date.getMonth()+1));
                gt5.push(data[i].GT);
            }
        }

        ////convert to number
        gt1 = gt1.map(function (x) { return parseFloat(x)});
        gt2 = gt2.map(function (x) { return parseFloat(x)});
        gt3 = gt3.map(function (x) { return parseFloat(x)});
        gt4 = gt4.map(function (x) { return parseFloat(x)});
        gt5 = gt5.map(function (x) { return parseFloat(x)});
        
        var log_1 = sum(gt1);
        var log_2 = sum(gt2);
        var log_3 = sum(gt3);
        var log_4 = sum(gt4);
        var log_5 = sum(gt5);
        var passive_power_1 = 6 * gt1.length;
        var passive_power_2 = 6 * gt2.length;
        var passive_power_3 = 6 * gt3.length;
        var passive_power_4 = 6 * gt4.length;
        var passive_power_5 = 6 * gt5.length;

        draw_summary_graph(removeDups(months),[log_5,log_4,log_3,log_2,log_1],[passive_power_5,passive_power_4,passive_power_3,passive_power_2,passive_power_1]);
    });

</script>
</body>